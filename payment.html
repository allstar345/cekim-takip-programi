<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ödeme Takibi - Akademik İzleme</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gray-100">

    <script>
        const SUPABASE_URL_AUTH = 'https://vpxwjehzdbyekpfborbc.supabase.co';
        const SUPABASE_ANON_KEY_AUTH = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZweHdqZWh6ZGJ5ZWtwZmJvcmJjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc3NDgwMzYsImV4cCI6MjA3MzMyNDAzNn0.nFKMdfFeoGOgjZAcAke4ZeHxAhH2FLLNfMzD-QLQd18';
        const authStorageAdapter = { getItem: (key) => localStorage.getItem(key) || sessionStorage.getItem(key), setItem: ()=>{}, removeItem: ()=>{} };
        const supabaseAuth = supabase.createClient(SUPABASE_URL_AUTH, SUPABASE_ANON_KEY_AUTH, { auth: { storage: authStorageAdapter } });
        async function checkAuth() {
            const { data: { session } } = await supabaseAuth.auth.getSession();
            if (!session) { window.location.href = 'login.html'; }
        }
        checkAuth();
    </script>

    <header class="bg-white shadow-sm sticky top-0 z-10">
        <div class="container mx-auto p-4 flex justify-between items-center">
            <div class="flex items-center space-x-4">
                <img src="logo.png" alt="Logo" class="h-12 w-auto">
                <h1 class="text-xl font-bold text-gray-800">Akademik İzleme Ödeme Takibi</h1>
            </div>
            <div class="flex items-center space-x-2">
                <p class="text-sm text-gray-500 hidden sm:block">Fatih Gülbudak tarafından oluşturulmuştur.</p>
                <a href="dashboard.html" class="flex items-center justify-center text-sm bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-3 rounded-lg transition-colors duration-300">
                    Anasayfa'ya Dön
                </a>
                <button id="logout-btn" class="flex items-center justify-center text-sm bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-3 rounded-lg focus:outline-none focus:ring-4 focus:ring-red-300 transition-colors duration-300 shadow-sm">
                    <svg class="w-4 h-4 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15m3 0l3-3m0 0l-3-3m3 3H9" /></svg>
                    Çıkış Yap
                </button>
            </div>
        </div>
    </header>

    <main class="container mx-auto p-4 md:p-8">
        <div class="bg-white rounded-2xl shadow-lg p-6 md:p-8">
            <div class="flex justify-between items-center mb-6">
                <div id="navigation-controls" class="flex w-full justify-between items-center">
                    <button id="prev-month-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg transition-colors">
                        &larr; Önceki Dönem
                    </button>
                    <div id="period-display" class="text-center text-lg font-semibold text-gray-700"></div>
                    <button id="next-month-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg transition-colors">
                        Sonraki Dönem &rarr;
                    </button>
                </div>
            </div>
             <div class="flex justify-end mb-4">
                <button id="mark-all-paid-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">
                    Tümünü Ödendi Olarak İşaretle
                </button>
            </div>
            <div id="payment-table-container" class="overflow-x-auto">
                </div>
            <div id="loading" class="text-center p-8">
                <p class="text-gray-500">Ödeme verileri hesaplanıyor...</p>
            </div>
        </div>
    </main>

    <script>
        const db = supabase.createClient(SUPABASE_URL_AUTH, SUPABASE_ANON_KEY_AUTH);
        
        const loadingDiv = document.getElementById('loading');
        const tableContainer = document.getElementById('payment-table-container');
        const prevMonthBtn = document.getElementById('prev-month-btn');
        const nextMonthBtn = document.getElementById('next-month-btn');
        const periodDisplay = document.getElementById('period-display');
        const markAllPaidBtn = document.getElementById('mark-all-paid-btn');
        const logoutBtn = document.getElementById('logout-btn');

        const HOURLY_RATE = 500;
        let currentDate = new Date();

        // DÜZELTME: Saat dilimi sorununu önlemek için yeni bir fonksiyon
        function toYYYYMMDD(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function getPaymentPeriod(date) {
            let year = date.getFullYear();
            let month = date.getMonth(); // 0-11
            
            let endBoundary, start;

            if (date.getDate() >= 10) {
                endBoundary = new Date(year, month + 1, 10);
            } else {
                endBoundary = new Date(year, month, 10);
            }
            start = new Date(endBoundary.getFullYear(), endBoundary.getMonth() - 1, 10);
            
            let inclusiveEnd = new Date(endBoundary);
            inclusiveEnd.setDate(inclusiveEnd.getDate() - 1);

            return {
                start: toYYYYMMDD(start),
                end: toYYYYMMDD(inclusiveEnd)
            };
        }
        
        function HHMMToMinutes(timeStr) {
            if (!timeStr || !timeStr.includes(':')) return 0;
            const [hours, minutes] = timeStr.split(':').map(Number);
            return (hours * 60) + minutes;
        }

        function minutesToHHMM(totalMinutes) {
            if (totalMinutes < 0) totalMinutes = 0;
            const hours = Math.floor(totalMinutes / 60);
            const minutes = totalMinutes % 60;
            return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
        }
        
        async function fetchAndRenderData() {
            loadingDiv.style.display = 'block';
            tableContainer.innerHTML = '';

            const period = getPaymentPeriod(currentDate);
            periodDisplay.textContent = `${new Date(period.start+'T00:00:00').toLocaleDateString('tr-TR')} - ${new Date(period.end+'T00:00:00').toLocaleDateString('tr-TR')}`;

            const { data: logs, error: logsError } = await db.from('monitoring_logs')
                .select('teacher_name, total_duration')
                .gte('date', period.start)
                .lte('date', period.end);

            const { data: payments, error: paymentsError } = await db.from('payment_records')
                .select('*')
                .eq('payment_period_start', period.start)
                .eq('payment_period_end', period.end);
            
            if(logsError || paymentsError) {
                tableContainer.innerHTML = `<p class="text-red-500">Veri çekerken hata oluştu.</p>`;
                console.error(logsError || paymentsError);
                loadingDiv.style.display = 'none';
                return;
            }

            const teacherData = {};

            logs.forEach(log => {
                if (!teacherData[log.teacher_name]) {
                    teacherData[log.teacher_name] = { currentTotalMinutes: 0, paidTotalMinutes: 0 };
                }
                teacherData[log.teacher_name].currentTotalMinutes += HHMMToMinutes(log.total_duration);
            });
            
            payments.forEach(payment => {
                 if (!teacherData[payment.teacher_name]) {
                    teacherData[payment.teacher_name] = { currentTotalMinutes: 0, paidTotalMinutes: 0 };
                }
                teacherData[payment.teacher_name].paidTotalMinutes += payment.paid_duration_minutes;
            });
            
            const sortedTeachers = Object.keys(teacherData).sort((a, b) => a.localeCompare(b, 'tr'));

            let tableHTML = `
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Öğretmen</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Toplam Süre</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Ödenecek Tutar</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Durum</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
            `;
            
            if (sortedTeachers.length === 0) {
                 tableHTML += `<tr><td colspan="4" class="text-center p-4 text-gray-500">Bu dönem için kayıt bulunamadı.</td></tr>`;
            }

            sortedTeachers.forEach(name => {
                const data = teacherData[name];
                const dueMinutes = data.currentTotalMinutes - data.paidTotalMinutes;

                if (data.paidTotalMinutes > 0) {
                    const paidDurationHHMM = minutesToHHMM(data.paidTotalMinutes);
                    const paidAmount = (data.paidTotalMinutes / 60) * HOURLY_RATE;
                    tableHTML += `
                        <tr class="bg-green-50">
                            <td class="px-6 py-4 font-medium">${name}</td>
                            <td class="px-6 py-4">${paidDurationHHMM}</td>
                            <td class="px-6 py-4">${paidAmount.toLocaleString('tr-TR', { style: 'currency', currency: 'TRY' })}</td>
                            <td class="px-6 py-4">
                                <span class="px-3 py-1 text-sm font-semibold text-green-800 bg-green-200 rounded-full">Ödendi</span>
                            </td>
                        </tr>
                    `;
                }
                
                if (dueMinutes > 0) {
                    const dueDurationHHMM = minutesToHHMM(dueMinutes);
                    const dueAmount = (dueMinutes / 60) * HOURLY_RATE;
                    tableHTML += `
                        <tr class="bg-red-50">
                            <td class="px-6 py-4 font-medium">${name} ${data.paidTotalMinutes > 0 ? '<span class="text-xs text-blue-600 font-bold">(Ek Ödeme)</span>' : ''}</td>
                            <td class="px-6 py-4">${dueDurationHHMM}</td>
                            <td class="px-6 py-4">${dueAmount.toLocaleString('tr-TR', { style: 'currency', currency: 'TRY' })}</td>
                            <td class="px-6 py-4">
                                <select class="payment-status-select bg-red-200 text-red-800 rounded-lg p-2 border-red-300" 
                                        data-teacher-name="${name}" 
                                        data-due-minutes="${dueMinutes}" 
                                        data-due-amount="${dueAmount}">
                                    <option value="unpaid" selected>Ödenmedi</option>
                                    <option value="paid">Ödendi</option>
                                </select>
                            </td>
                        </tr>
                    `;
                }
            });

            tableHTML += `</tbody></table>`;
            tableContainer.innerHTML = tableHTML;
            loadingDiv.style.display = 'none';
        }
        
        async function handlePayment(teacherName, dueMinutes, dueAmount) {
             const period = getPaymentPeriod(currentDate);
             const { error } = await db.from('payment_records').insert([{
                 teacher_name: teacherName,
                 payment_period_start: period.start,
                 payment_period_end: period.end,
                 paid_duration_minutes: dueMinutes,
                 paid_amount: dueAmount
             }]);

             if (error) {
                 alert('Ödeme kaydedilirken bir hata oluştu!');
                 console.error(error);
             } else {
                 fetchAndRenderData(); 
             }
        }

        tableContainer.addEventListener('change', (e) => {
            if (e.target.classList.contains('payment-status-select') && e.target.value === 'paid') {
                const select = e.target;
                const { teacherName, dueMinutes, dueAmount } = select.dataset;
                select.disabled = true; 
                handlePayment(teacherName, parseInt(dueMinutes), parseFloat(dueAmount));
            }
        });

        markAllPaidBtn.addEventListener('click', async () => {
             const selects = document.querySelectorAll('.payment-status-select');
             const paymentsToInsert = [];
             const period = getPaymentPeriod(currentDate);

             selects.forEach(select => {
                 const { teacherName, dueMinutes, dueAmount } = select.dataset;
                 paymentsToInsert.push({
                     teacher_name: teacherName,
                     payment_period_start: period.start,
                     payment_period_end: period.end,
                     paid_duration_minutes: parseInt(dueMinutes),
                     paid_amount: parseFloat(dueAmount)
                 });
             });
             
             if(paymentsToInsert.length === 0) {
                 alert('Ödenecek kayıt bulunmamaktadır.');
                 return;
             }

             const { error } = await db.from('payment_records').insert(paymentsToInsert);
             if (error) {
                 alert('Toplu ödeme kaydedilirken bir hata oluştu!');
                 console.error(error);
             } else {
                 fetchAndRenderData();
             }
        });
        
        prevMonthBtn.addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() - 1);
            fetchAndRenderData();
        });

        nextMonthBtn.addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() + 1);
            fetchAndRenderData();
        });
        
        logoutBtn.addEventListener('click', async () => {
            await supabaseAuth.auth.signOut();
            window.location.href = 'login.html';
        });

        document.addEventListener('DOMContentLoaded', fetchAndRenderData);
    </script>
</body>
</html>
