<script>
        // --- SUPABASE AYARLARI ---
        const SUPABASE_URL = 'https://vpxwjehzdbyekpfborbc.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZweHdqZWh6ZGJ5ZWtwZmJvcmJjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc3NDgwMzYsImV4cCI6MjA3MzMyNDAzNn0.nFKMdfFeoGOgjZAcAke4ZeHxAhH2FLLNfMzD-QLQd18';

        const { createClient } = supabase;
        const db = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- GLOBAL STATE ---
        let allShoots = [];
        let groupedShoots = {};
        let sortedWeeks = [];
        let currentPage = 0;
        let currentEditId = null;

        // --- DOM ELEMENTS ---
        const form = document.getElementById('shoot-form');
        const weeklyContainer = document.getElementById('weekly-view-container');
        const loadingDiv = document.getElementById('loading');
        const noDataDiv = document.getElementById('no-data');
        const prevBtn = document.getElementById('prev-week-btn');
        const nextBtn = document.getElementById('next-week-btn');
        const weekRangeDisplay = document.getElementById('week-range-display');
        const navControls = document.getElementById('navigation-controls');
        const submitBtn = document.getElementById('submit-btn');
        const cancelBtn = document.getElementById('cancel-edit-btn');

        // --- HELPER FUNCTIONS (YARDIMCI FONKSİYONLAR) ---
        function getWeekIdentifier(d) {
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            const dayNum = d.getUTCDay() || 7;
            d.setUTCDate(d.getUTCDate() + 4 - dayNum);
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
            return `${d.getUTCFullYear()}-${String(weekNo).padStart(2, '0')}`;
        }
        
        function getMondayOfIsoWeek(year, week) {
            const simple = new Date(Date.UTC(year, 0, 1 + (week - 1) * 7));
            const dayOfWeek = simple.getUTCDay();
            const isoWeekStart = simple;
            if (dayOfWeek <= 4) {
                isoWeekStart.setUTCDate(simple.getUTCDate() - simple.getUTCDay() + 1);
            } else {
                isoWeekStart.setUTCDate(simple.getUTCDate() + 8 - simple.getUTCDay());
            }
            return isoWeekStart;
        }

        function getWeekDateRange(year, weekNo) {
            const monday = getMondayOfIsoWeek(year, weekNo);
            const sunday = new Date(monday);
            sunday.setUTCDate(monday.getUTCDate() + 6);
            return { start: monday, end: sunday };
        }

        // --- ANA MANTIK ---
        function processAndRenderData() {
            groupedShoots = {};
            allShoots.forEach(shoot => {
                if (shoot.date) {
                    const shootDate = new Date(shoot.date + 'T00:00:00');
                    if (!isNaN(shootDate.getTime())) {
                        const weekKey = getWeekIdentifier(shootDate);
                        if (!groupedShoots[weekKey]) {
                            groupedShoots[weekKey] = [];
                        }
                        groupedShoots[weekKey].push(shoot);
                    }
                }
            });
            sortedWeeks = Object.keys(groupedShoots).sort().reverse();
            renderCurrentPage();
        }

        function renderCurrentPage() {
            loadingDiv.classList.add('hidden');
            weeklyContainer.innerHTML = '';

            if (sortedWeeks.length === 0) {
                noDataDiv.classList.remove('hidden');
                navControls.classList.add('hidden');
                return;
            }
            
            noDataDiv.classList.add('hidden');
            navControls.classList.remove('hidden');

            const startIndex = currentPage * 2;
            const weeksToShow = sortedWeeks.slice(startIndex, startIndex + 2);

            weeksToShow.forEach(weekKey => {
                const [year, weekNo] = weekKey.split('-').map(Number);
                const dateRange = getWeekDateRange(year, weekNo);
                const shootsForWeek = groupedShoots[weekKey].sort((a, b) => {
                    const dateA = new Date(a.date);
                    const dateB = new Date(b.date);
                    if (dateA - dateB !== 0) return dateA - dateB;
                    const studioA = a.studio || '';
                    const studioB = b.studio || '';
                    const studioCompare = studioA.localeCompare(studioB, 'tr', { numeric: true });
                    if (studioCompare !== 0) return studioCompare;
                    const timeA = (a.time || '').split('-')[0].trim();
                    const timeB = (b.time || '').split('-')[0].trim();
                    return timeA.localeCompare(timeB);
                });
                const weekHtml = createWeekTableHtml(dateRange, shootsForWeek);
                weeklyContainer.insertAdjacentHTML('beforeend', weekHtml);
            });
            
            updateNavControls();
        }

        function createWeekTableHtml(dateRange, shoots) {
            const options = { day: 'numeric', month: 'long', year: 'numeric' };
            const startStr = dateRange.start.toLocaleDateString('tr-TR', options);
            const endStr = dateRange.end.toLocaleDateString('tr-TR', options);
            
            const rowsHtml = shoots.map((shoot, index) => `
                <tr class="${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'} hover:bg-blue-50 transition-colors duration-200">
                    <td class="whitespace-nowrap p-4"><div class="font-medium text-gray-900">${shoot.studio || ''}</div></td>
                    <td class="whitespace-nowrap p-4"><div class="text-gray-700">${shoot.teacher || ''}</div></td>
                    <td class="whitespace-nowrap p-4"><div class="text-gray-700">${shoot.date ? new Date(shoot.date + 'T00:00:00').toLocaleDateString('tr-TR', {day: '2-digit', month: '2-digit', year: 'numeric'}) : ''}</div></td>
                    <td class="whitespace-nowrap p-4"><div class="text-gray-700">${shoot.day || ''}</div></td>
                    <td class="whitespace-nowrap p-4"><div class="text-gray-700">${shoot.time || ''}</div></td>
                    <td class="whitespace-nowrap p-4"><div class="text-gray-700">${shoot.director || ''}</div></td>
                    <td class="p-4"><div class="text-gray-700">${shoot.content || ''}</div></td>
                    <td class="whitespace-nowrap p-4 text-sm font-medium">
                        <div class="flex items-center space-x-2">
                             <button data-id="${shoot.id}" class="edit-btn text-indigo-600 hover:text-indigo-900 px-3 py-1 rounded-md bg-indigo-100 hover:bg-indigo-200 transition-all duration-200">Düzenle</button>
                             <button data-id="${shoot.id}" class="delete-btn text-red-600 hover:text-red-900 px-3 py-1 rounded-md bg-red-100 hover:bg-red-200 transition-all duration-200">Sil</button>
                        </div>
                    </td>
                </tr>
            `).join('');

            return `
                <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
                    <div class="p-6 md:p-8 bg-gray-50 border-b border-gray-200">
                        <h2 class="text-xl font-bold text-gray-900">Çekim Planı: ${startStr} - ${endStr}</h2>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full table-auto">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="p-4 text-sm font-bold text-gray-700 uppercase tracking-wider text-left">Stüdyo</th>
                                    <th class="p-4 text-sm font-bold text-gray-700 uppercase tracking-wider text-left">Öğretmen</th>
                                    <th class="p-4 text-sm font-bold text-gray-700 uppercase tracking-wider text-left">Tarih</th>
                                    <th class="p-4 text-sm font-bold text-gray-700 uppercase tracking-wider text-left">Gün</th>
                                    <th class="p-4 text-sm font-bold text-gray-700 uppercase tracking-wider text-left">Çekim Saati</th>
                                    <th class="p-4 text-sm font-bold text-gray-700 uppercase tracking-wider text-left">Yönetmen</th>
                                    <th class="p-4 text-sm font-bold text-gray-700 uppercase tracking-wider text-left">Çekim İçeriği</th>
                                    <th class="p-4 text-sm font-bold text-gray-700 uppercase tracking-wider text-left">İşlemler</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200">${rowsHtml}</tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function updateNavControls() {
            nextBtn.disabled = currentPage === 0;
            const maxPage = Math.ceil(sortedWeeks.length / 2) - 1;
            prevBtn.disabled = currentPage >= maxPage;

            const startIndex = currentPage * 2;
            const week1Key = sortedWeeks[startIndex];
            const week2Key = sortedWeeks[startIndex + 1];

            let displayStr = 'Gösterilen Haftalar: ';
            if (week1Key) {
                const [y1, w1] = week1Key.split('-').map(Number);
                const r1 = getWeekDateRange(y1, w1);
                displayStr += `${r1.start.toLocaleDateString('tr-TR', {day:'numeric', month:'short'})}`;
            }
            if (week2Key) {
                 const [y2, w2] = week2Key.split('-').map(Number);
                 const r2 = getWeekDateRange(y2, w2);
                 displayStr += ` & ${r2.start.toLocaleDateString('tr-TR', {day:'numeric', month:'short'})}`;
            } else if (week1Key) {
                 const [y1, w1] = week1Key.split('-').map(Number);
                 const r1 = getWeekDateRange(y1, w1);
                 displayStr = `Gösterilen Hafta: ${r1.start.toLocaleDateString('tr-TR', {day:'numeric', month:'short'})} - ${r1.end.toLocaleDateString('tr-TR', {day:'numeric', month:'short'})}`
            }
            weekRangeDisplay.textContent = displayStr;
        }

        function populateFormForEdit(shoot) {
            form.date.value = shoot.date || '';
            form.day.value = shoot.day || '';
            form.studio.value = shoot.studio || '';
            form.teacher.value = shoot.teacher || '';
            form.time.value = shoot.time || '';
            form.director.value = shoot.director || '';
            form.content.value = shoot.content || '';

            currentEditId = shoot.id;
            submitBtn.textContent = 'Kaydı Güncelle';
            cancelBtn.classList.remove('hidden');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function resetFormState() {
            form.reset();
            currentEditId = null;
            submitBtn.textContent = 'Çekim Ekle';
            cancelBtn.classList.add('hidden');
        }
        
        // --- EVENT LISTENERS (OLAY DİNLEYİCİLERİ) ---
        prevBtn.addEventListener('click', () => {
            const maxPage = Math.ceil(sortedWeeks.length / 2) - 1;
            if (currentPage < maxPage) {
                currentPage++;
                renderCurrentPage();
            }
        });

        nextBtn.addEventListener('click', () => {
            if (currentPage > 0) {
                currentPage--;
                renderCurrentPage();
            }
        });

        weeklyContainer.addEventListener('click', async (e) => {
            const target = e.target;
            if (target.classList.contains('delete-btn')) {
                const id = target.getAttribute('data-id');
                const { error } = await db.from('shoots').delete().eq('id', id);
                if(error) console.error("Veri silme hatası:", error);
            }
            if (target.classList.contains('edit-btn')) {
                const id = target.getAttribute('data-id');
                const shootToEdit = allShoots.find(shoot => shoot.id == id);
                if (shootToEdit) {
                    populateFormForEdit(shootToEdit);
                }
            }
        });
        
        cancelBtn.addEventListener('click', resetFormState);

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(form);
            const shootData = {
                studio: formData.get('studio'),
                teacher: formData.get('teacher'),
                date: formData.get('date'),
                day: formData.get('day'),
                time: formData.get('time'),
                director: formData.get('director'),
                content: formData.get('content'),
            };

            let error;
            if (currentEditId) {
                ({ error } = await db.from('shoots').update(shootData).eq('id', currentEditId));
            } else {
                ({ error } = await db.from('shoots').insert([shootData]));
            }

            if (error) {
                console.error("Veri kaydetme/güncelleme hatası: ", error);
            } else {
                resetFormState();
            }
        });

        // --- BAŞLATMA ---
        async function fetchInitialData() {
            const { data, error } = await db.from('shoots').select('*');
            if (error) {
                console.error("Veri alınamadı:", error);
                loadingDiv.innerText = "Veriler alınırken bir hata oluştu.";
            } else {
                allShoots = data;
                processAndRenderData();
            }
        }
        
        const shootsSubscription = db.channel('public:shoots')
            .on(
                'postgres_changes',
                { event: '*', schema: 'public', table: 'shoots' },
                (payload) => {
                    console.log('Değişiklik algılandı!', payload);
                    fetchInitialData();
                }
            )
            .subscribe();

        fetchInitialData();
    </script>
