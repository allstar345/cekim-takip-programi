<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Çekim Takip Programı</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        #form-wrapper { max-height: 1000px; overflow: hidden; transition: max-height 0.5s ease-in-out, padding 0.5s ease-in-out; }
        #form-wrapper.collapsed { max-height: 0; padding-top: 0 !important; padding-bottom: 0 !important; }
        .timetable { border-collapse: collapse; width: 100%; }
        .timetable th, .timetable td { border: 1px solid #d1d5db; padding: 0; vertical-align: top; }
        .timetable th { padding: 12px 8px; background-color: #f9fafb; text-align: center; }
        .timetable .day-header { padding: 12px 8px; font-weight: 600; text-align: center; min-width: 120px; }
        .timetable .timetable-cell { min-height: 120px; }
        .timetable .shoot-entry { padding: 8px; font-size: 0.875rem; border-bottom: 1px solid #e5e7eb; }
        .timetable .shoot-entry:last-child { border-bottom: none; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <script>
        const SUPABASE_URL_AUTH = 'https://vpxwjehzdbyekpfborbc.supabase.co';
        const SUPABASE_ANON_KEY_AUTH = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZweHdqZWh6ZGJ5ZWtwZmJvcmJjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc3NDgwMzYsImV4cCI6MjA3MzMyNDAzNn0.nFKMdfFeoGOgjZAcAke4ZeHxAhH2FLLNfMzD-QLQd18';
        
        const authStorageAdapter = {
            getItem: (key) => localStorage.getItem(key) || sessionStorage.getItem(key),
            setItem: (key, value) => {},
            removeItem: (key) => {},
        };

        const supabaseAuth = supabase.createClient(SUPABASE_URL_AUTH, SUPABASE_ANON_KEY_AUTH, {
            auth: { storage: authStorageAdapter },
        });

        async function checkAuth() {
            const { data: { session } } = await supabaseAuth.auth.getSession();
            if (!session) {
                window.location.href = 'login.html';
            }
        }
        checkAuth();
    </script>

    <div class="container mx-auto p-4 md:p-8">
        <div class="bg-white rounded-2xl shadow-lg mb-8">
            <div id="form-header" class="flex flex-col md:flex-row md:justify-between md:items-start p-6 md:p-8">
                <div id="form-header-clickable" class="w-full flex items-center justify-between md:justify-start cursor-pointer">
                    <div class="flex items-center">
                        <img src="logo.png" alt="Logo" class="h-24 md:h-32 w-auto mr-4">
                        <h1 class="text-xl md:text-3xl font-bold text-gray-900">Çekim Takip Programı</h1>
                    </div>
                    <button id="toggle-form-btn" class="p-2 rounded-full hover:bg-gray-100 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 self-center ml-4">
                        <svg id="toggle-icon" class="w-6 h-6 text-gray-600 transition-transform duration-300" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
                        </svg>
                    </button>
                </div>
                <div class="w-full md:w-auto text-center md:text-right mt-4 md:mt-0 space-y-2">
                    <p class="text-sm text-gray-500 font-medium">Fatih Gülbudak tarafından oluşturulmuştur.</p>
                    <div class="flex justify-center md:justify-end">
                        <button id="logout-btn" class="flex items-center justify-center text-sm bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-3 rounded-lg focus:outline-none focus:ring-4 focus:ring-red-300 transition-colors duration-300 shadow-sm">
                            <svg class="w-4 h-4 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15m3 0l3-3m0 0l-3-3m3 3H9" /></svg>
                            Çıkış Yap
                        </button>
                    </div>
                </div>
            </div>
            
            <div id="form-wrapper" class="px-6 md:px-8 pb-8">
                <form id="shoot-form" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 items-end">
                    <div>
                        <label for="date" class="block text-sm font-medium text-gray-700 mb-2">Tarih</label>
                        <input type="date" id="date" name="date" class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5">
                    </div>
                    <div>
                        <label for="day" class="block text-sm font-medium text-gray-700 mb-2">Gün</label>
                        <select id="day" name="day" class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5">
                            <option value="" selected disabled>Seçiniz</option>
                            <option value="Pazartesi">Pazartesi</option>
                            <option value="Salı">Salı</option>
                            <option value="Çarşamba">Çarşamba</option>
                            <option value="Perşembe">Perşembe</option>
                            <option value="Cuma">Cuma</option>
                            <option value="Cumartesi">Cumartesi</option>
                            <option value="Pazar">Pazar</option>
                        </select>
                    </div>
                    <div>
                        <label for="studio" class="block text-sm font-medium text-gray-700 mb-2">Stüdyo Seçimi</label>
                        <select id="studio" name="studio" class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5">
                             <option value="" selected disabled>Seçiniz</option>
                             <option value="Stüdyo 1">Stüdyo 1</option>
                             <option value="Stüdyo 2">Stüdyo 2</option>
                             <option value="Stüdyo 4">Stüdyo 4</option>
                             <option value="Stüdyo 7">Stüdyo 7</option>
                             <option value="Stüdyo 8">Stüdyo 8</option>
                        </select>
                    </div>
                    <div>
                        <label for="teacher" class="block text-sm font-medium text-gray-700 mb-2">Öğretmen Adı</label>
                        <select id="teacher" name="teacher" class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5">
                            <option value="" selected disabled>Seçiniz</option>
                            <option value="Ali Saçan">Ali Saçan</option>
                            <option value="Altuğ Güneş">Altuğ Güneş</option>
                            <option value="Anıl Gül">Anıl Gül</option>
                            <option value="Bayram Meral">Bayram Meral</option>
                            <option value="Betül Büyükkalaycı">Betül Büyükkalaycı</option>
                            <option value="Buğra Arslan">Buğra Arslan</option>
                            <option value="Büşra Altınok">Büşra Altınok</option>
                            <option value="Cebrail Karaoğlan">Cebrail Karaoğlan</option>
                            <option value="Celal Gündüz">Celal Gündüz</option>
                            <option value="Deniz Bozkurt">Deniz Bozkurt</option>
                            <option value="Didar Baskın">Didar Baskın</option>
                            <option value="Emrah Karcı">Emrah Karcı</option>
                            <option value="Enes Avcı">Enes Avcı</option>
                            <option value="Erdal Aydemir">Erdal Aydemir</option>
                            <option value="Erkan Ayrancı">Erkan Ayrancı</option>
                            <option value="Erkan Tunçer">Erkan Tunçer</option>
                            <option value="Ersen Örenler">Ersen Örenler</option>
                            <option value="Eyüp Boncuk">Eyüp Boncuk</option>
                            <option value="Fatih Demirkaya">Fatih Demirkaya</option>
                            <option value="Fatih Sefi">Fatih Sefi</option>
                            <option value="Görkem Şahin">Görkem Şahin</option>
                            <option value="Gülhan Şen">Gülhan Şen</option>
                            <option value="Hale Karataş">Hale Karataş</option>
                            <option value="İbrahim Taş">İbrahim Taş</option>
                            <option value="İbrahim Ulaş Baldemir">İbrahim Ulaş Baldemir</option>
                            <option value="İlayda Gültekin">İlayda Gültekin</option>
                            <option value="İlhan Aslan">İlhan Aslan</option>
                            <option value="İlyas Güneş">İlyas Güneş</option>
                            <option value="İsmail Kocabaş">İsmail Kocabaş</option>
                            <option value="Kader Altınel">Kader Altınel</option>
                            <option value="Kadir Gümüş">Kadir Gümüş</option>
                            <option value="Kadir Sefi">Kadir Sefi</option>
                            <option value="Kemal Coşkun">Kemal Coşkun</option>
                            <option value="Kenan Kara">Kenan Kara</option>
                            <option value="Mahsum Öztürk">Mahsum Öztürk</option>
                            <option value="Mehmet Celal Özyıldız">Mehmet Celal Özyıldız</option>
                            <option value="Mehmet Dural">Mehmet Dural</option>
                            <option value="Mehmet Durmuş">Mehmet Durmuş</option>
                            <option value="Mehmet Özalp">Mehmet Özalp</option>
                            <option value="Melih Akgündüz">Melih Akgündüz</option>
                            <option value="Mesut Uğurdoğan">Mesut Uğurdoğan</option>
                            <option value="Murat Namlı">Murat Namlı</option>
                            <option value="Mustafa Öztürk">Mustafa Öztürk</option>
                            <option value="Mustafa Yağcı">Mustafa Yağcı</option>
                            <option value="Nagihan Damargüç">Nagihan Damargüç</option>
                            <option value="Nurtaç Kozak">Nurtaç Kozak</option>
                            <option value="Nurten Aydın">Nurten Aydın</option>
                            <option value="Onur Soğuk">Onur Soğuk</option>
                            <option value="Önay Çepe">Önay Çepe</option>
                            <option value="Özer Akgümüş">Özer Akgümüş</option>
                            <option value="Özcan Aykın">Özcan Aykın</option>
                            <option value="Öznur Saat Yıldırım">Öznur Saat Yıldırım</option>
                            <option value="Recep Üstünel">Recep Üstünel</option>
                            <option value="Rıdvan Çelebi">Rıdvan Çelebi</option>
                            <option value="Rümeysa Enise Özdemir">Rümeysa Enise Özdemir</option>
                            <option value="Rüştü Bayındır">Rüştü Bayındır</option>
                            <option value="Salih Yıldırır">Salih Yıldırır</option>
                            <option value="Selim Yüksel">Selim Yüksel</option>
                            <option value="Semih Akpınar">Semih Akpınar</option>
                            <option value="Sercan Dural">Sercan Dural</option>
                            <option value="Serkan Yeşilkan">Serkan Yeşilkan</option>
                            <option value="Sinan Aydın">Sinan Aydın</option>
                            <option value="Şenol Aydın">Şenol Aydın</option>
                            <option value="Şükrü Akkoyun">Şükrü Akkoyun</option>
                            <option value="Umut Öncül">Umut Öncül</option>
                            <option value="Uzay Arslantürk">Uzay Arslantürk</option>
                            <option value="Veysel Boynueğri">Veysel Boynueğri</option>
                            <option value="Yavuz Tuna">Yavuz Tuna</option>
                            <option value="Yaşar Aslan">Yaşar Aslan</option>
                            <option value="Yunus Turan">Yunus Turan</option>
                        </select>
                    </div>
                    <div class="md:col-span-2 lg:col-span-2">
                        <label for="time" class="block text-sm font-medium text-gray-700 mb-2">Çekim Saatleri</label>
                        <input type="text" id="time" name="time" class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5" placeholder="Örn: 10:00 - 12:00">
                    </div>
                    <div class="md:col-span-2 lg:col-span-2">
                        <label for="director" class="block text-sm font-medium text-gray-700 mb-2">Yönetmen</label>
                        <input type="text" id="director" name="director" class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5" placeholder="Örn: Zeynep Kaya">
                    </div>
                     <div class="col-span-full">
                        <label for="content" class="block text-sm font-medium text-gray-700 mb-2">Çekim İçeriği</label>
                        <input type="text" id="content" name="content" class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5" placeholder="Örn: Konu Anlatımı, Soru Çözümü">
                    </div>
                    <div class="col-span-full flex space-x-2">
                         <button type="submit" id="submit-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2.5 px-4 rounded-lg focus:outline-none focus:ring-4 focus:ring-blue-300 transition duration-300 ease-in-out">
                             Çekim Ekle
                         </button>
                         <button type="button" id="cancel-edit-btn" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-2.5 px-4 rounded-lg focus:outline-none focus:ring-4 focus:ring-gray-300 transition duration-300 ease-in-out hidden">
                             İptal
                         </button>
                    </div>
                </form>
            </div>
        </div>
        
        <div class="bg-white rounded-2xl shadow-lg p-4 md:p-6 mb-8">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                    <label for="filter-day" class="block text-sm font-medium text-gray-700 mb-2">Güne Göre Filtrele</label>
                    <select id="filter-day" class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5">
                        <option value="">Tümü</option>
                        <option value="Pazartesi">Pazartesi</option>
                        <option value="Salı">Salı</option>
                        <option value="Çarşamba">Çarşamba</option>
                        <option value="Perşembe">Perşembe</option>
                        <option value="Cuma">Cuma</option>
                        <option value="Cumartesi">Cumartesi</option>
                        <option value="Pazar">Pazar</option>
                    </select>
                </div>
                 <div>
                    <label for="filter-studio" class="block text-sm font-medium text-gray-700 mb-2">Stüdyoya Göre Filtrele</label>
                    <select id="filter-studio" class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5">
                         <option value="">Tümü</option>
                         <option value="Stüdyo 1">Stüdyo 1</option>
                         <option value="Stüdyo 2">Stüdyo 2</option>
                         <option value="Stüdyo 4">Stüdyo 4</option>
                         <option value="Stüdyo 7">Stüdyo 7</option>
                         <option value="Stüdyo 8">Stüdyo 8</option>
                    </select>
                </div>
                <div>
                    <label for="filter-teacher" class="block text-sm font-medium text-gray-700 mb-2">Öğretmene Göre Filtrele</label>
                    <select id="filter-teacher" class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5">
                        <option value="">Tümü</option>
                    </select>
                </div>
                <div id="record-count" class="text-sm font-medium text-gray-600 self-end pb-2.5">
                    Toplam 0 kayıt bulundu.
                </div>
            </div>
            <div class="flex justify-end mt-4">
                <button id="download-pdf-btn" class="flex items-center justify-center bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:ring-4 focus:ring-green-300 transition duration-300 ease-in-out disabled:opacity-50">
                    <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" /></svg>
                    PDF Olarak İndir
                </button>
            </div>
        </div>

        <div class="space-y-8">
            <div id="navigation-controls" class="flex justify-between items-center bg-white p-4 rounded-2xl shadow-lg hidden">
                <button id="prev-week-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
                    &larr; Önceki Hafta
                </button>
                <div id="week-range-display" class="text-center text-base md:text-lg font-semibold text-gray-700"></div>
                <button id="next-week-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
                    Sonraki Hafta &rarr;
                </button>
            </div>
            <div id="weekly-view-container" class="space-y-8"></div>
             <div id="loading" class="text-center p-8 bg-white rounded-2xl shadow-lg">
                 <p class="text-gray-500">Veriler yükleniyor...</p>
             </div>
             <div id="no-data" class="text-center p-8 bg-white rounded-2xl shadow-lg hidden">
                 <p class="text-gray-500">Gösterilecek çekim planı bulunmamaktadır.</p>
             </div>
        </div>
    </div>
    
    <script>
        const mainStorageAdapter = {
            getItem: (key) => localStorage.getItem(key) || sessionStorage.getItem(key),
            setItem: (key, value) => { localStorage.setItem(key, value); },
            removeItem: (key) => { localStorage.removeItem(key); sessionStorage.removeItem(key); },
        };

        const db = supabase.createClient(SUPABASE_URL_AUTH, SUPABASE_ANON_KEY_AUTH, {
            auth: { storage: mainStorageAdapter }
        });
        
        let allShoots = []; 
        let groupedShoots = {};
        let sortedWeeks = [];
        let currentPage = 0;
        let currentEditId = null;

        const form = document.getElementById('shoot-form');
        const weeklyContainer = document.getElementById('weekly-view-container');
        const loadingDiv = document.getElementById('loading');
        const noDataDiv = document.getElementById('no-data');
        const prevBtn = document.getElementById('prev-week-btn');
        const nextBtn = document.getElementById('next-week-btn');
        const weekRangeDisplay = document.getElementById('week-range-display');
        const navControls = document.getElementById('navigation-controls');
        const submitBtn = document.getElementById('submit-btn');
        const cancelBtn = document.getElementById('cancel-edit-btn');
        const formHeaderClickable = document.getElementById('form-header-clickable');
        const formWrapper = document.getElementById('form-wrapper');
        const toggleIcon = document.getElementById('toggle-icon');
        const filterDay = document.getElementById('filter-day');
        const filterStudio = document.getElementById('filter-studio');
        const filterTeacher = document.getElementById('filter-teacher');
        const recordCount = document.getElementById('record-count');
        const downloadPdfBtn = document.getElementById('download-pdf-btn');
        const logoutBtn = document.getElementById('logout-btn');
        
        const DAYS_OF_WEEK = ["Pazartesi", "Salı", "Çarşamba", "Perşembe", "Cuma", "Cumartesi", "Pazar"];
        const STUDIOS = ["Stüdyo 1", "Stüdyo 2", "Stüdyo 4", "Stüdyo 7", "Stüdyo 8"];
        
        const teacherSelectForm = document.getElementById('teacher');
        const teacherSelectFilter = document.getElementById('filter-teacher');
        const teacherOptionsHtml = Array.from(teacherSelectForm.options).map(option => {
            if (option.value) { 
                return `<option value="${option.value}">${option.text}</option>`;
            }
            return '';
        }).join('');
        teacherSelectFilter.innerHTML = `<option value="">Tümü</option>${teacherOptionsHtml}`;
        
        function getRowColorClass(day) {
            switch (day) {
                case 'Pazartesi': return 'bg-green-50';
                case 'Salı': return 'bg-red-50';
                case 'Çarşamba': return 'bg-yellow-50';
                case 'Perşembe': return 'bg-purple-50';
                case 'Cuma': return 'bg-blue-50';
                case 'Cumartesi': return 'bg-orange-50';
                case 'Pazar': return 'bg-stone-100';
                default: return 'bg-white';
            }
        }

        function getWeekIdentifier(d) {
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            const dayNum = d.getUTCDay() || 7;
            d.setUTCDate(d.getUTCDate() + 4 - dayNum);
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
            return `${d.getUTCFullYear()}-${String(weekNo).padStart(2, '0')}`;
        }
        
        function getMondayOfIsoWeek(year, week) {
            const simple = new Date(Date.UTC(year, 0, 1 + (week - 1) * 7));
            const dayOfWeek = simple.getUTCDay();
            const isoWeekStart = simple;
            if (dayOfWeek <= 4) {
                isoWeekStart.setUTCDate(simple.getUTCDate() - simple.getUTCDay() + 1);
            } else {
                isoWeekStart.setUTCDate(simple.getUTCDate() + 8 - simple.getUTCDay());
            }
            return isoWeekStart;
        }

        function getWeekDateRange(year, weekNo) {
            const monday = getMondayOfIsoWeek(year, weekNo);
            const sunday = new Date(monday);
            sunday.setUTCDate(monday.getUTCDate() + 6);
            return { start: monday, end: sunday };
        }

        function processAndRenderData() {
            const selectedDay = filterDay.value;
            const selectedStudio = filterStudio.value;
            const selectedTeacher = filterTeacher.value;
            
            let filteredShoots = allShoots;

            if (selectedDay) {
                filteredShoots = filteredShoots.filter(shoot => shoot.day === selectedDay);
            }
            if (selectedStudio) {
                filteredShoots = filteredShoots.filter(shoot => shoot.studio === selectedStudio);
            }
            if (selectedTeacher) {
                filteredShoots = filteredShoots.filter(shoot => shoot.teacher === selectedTeacher);
            }

            recordCount.textContent = `Toplam ${filteredShoots.length} kayıt bulundu.`;

            groupedShoots = {};
            filteredShoots.forEach(shoot => {
                if (shoot.date) {
                    const shootDate = new Date(shoot.date + 'T00:00:00');
                    if (!isNaN(shootDate.getTime())) {
                        const weekKey = getWeekIdentifier(shootDate);
                        if (!groupedShoots[weekKey]) {
                            groupedShoots[weekKey] = [];
                        }
                        groupedShoots[weekKey].push(shoot);
                    }
                }
            });

            sortedWeeks = Object.keys(groupedShoots).sort().reverse();
            currentPage = 0;
            renderCurrentPage();
        }

        function renderCurrentPage() {
            loadingDiv.classList.add('hidden');
            weeklyContainer.innerHTML = '';

            const hasAnyData = Object.keys(groupedShoots).length > 0;

            if (!hasAnyData) {
                noDataDiv.classList.remove('hidden');
                navControls.classList.add('hidden');
                return;
            }
            
            noDataDiv.classList.add('hidden');
            navControls.classList.remove('hidden');

            const weekKey = sortedWeeks[currentPage];
            if (!weekKey) {
                 noDataDiv.classList.remove('hidden');
                navControls.classList.add('hidden');
                return;
            }
            
            const [year, weekNo] = weekKey.split('-').map(Number);
            const dateRange = getWeekDateRange(year, weekNo);
            const shootsForWeek = groupedShoots[weekKey];
            
            const timetableHtml = createTimetableHtml(dateRange, shootsForWeek);
            weeklyContainer.innerHTML = timetableHtml;
            
            updateNavControls();
        }

        function createTimetableHtml(dateRange, shoots) {
            const gridData = {};
            DAYS_OF_WEEK.forEach(day => {
                gridData[day] = {};
                STUDIOS.forEach(studio => {
                    gridData[day][studio] = [];
                });
            });

            shoots.forEach(shoot => {
                if (shoot.day && shoot.studio && gridData[shoot.day] && gridData[shoot.day][shoot.studio]) {
                    gridData[shoot.day][shoot.studio].push(shoot);
                }
            });

            const headerHtml = `
                <thead>
                    <tr>
                        <th class="w-1/12">Gün</th>
                        ${STUDIOS.map(studio => `<th>${studio}</th>`).join('')}
                    </tr>
                </thead>
            `;

            const bodyHtml = DAYS_OF_WEEK.map(day => {
                const dayColorClass = getRowColorClass(day);
                const cellsHtml = STUDIOS.map(studio => {
                    const shootsInCell = gridData[day][studio];
                    shootsInCell.sort((a,b) => (a.time || '').localeCompare(b.time || ''));

                    const cellContent = shootsInCell.map(shoot => `
                        <div class="shoot-entry text-left">
                            <p class="font-semibold text-gray-800">${shoot.teacher || ''}</p>
                            <p class="text-gray-600">${shoot.time || ''}</p>
                            <p class="text-gray-500 text-xs">${shoot.content || ''}</p>
                            <p class="text-gray-500 text-xs italic mt-1">${shoot.director || ''}</p>
                            <div class="flex items-center justify-end space-x-1 mt-2">
                                 <button data-id="${shoot.id}" class="edit-btn text-xs text-indigo-600 hover:text-indigo-900 p-1 rounded-md bg-indigo-50 hover:bg-indigo-100">D</button>
                                 <button data-id="${shoot.id}" class="delete-btn text-xs text-red-600 hover:text-red-900 p-1 rounded-md bg-red-50 hover:bg-red-100">S</button>
                            </div>
                        </div>
                    `).join('');
                    
                    return `<td class="timetable-cell">${cellContent}</td>`;
                }).join('');
                
                return `<tr class="${dayColorClass} hover:brightness-95 transition-all duration-200"><td class="day-header">${day}</td>${cellsHtml}</tr>`;
            }).join('');

            return `
                 <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
                    <div class="p-6 md:p-8 bg-gray-50 border-b border-gray-200">
                        <h2 class="text-xl font-bold text-gray-900">Çekim Planı</h2>
                    </div>
                    <div class="overflow-x-auto p-4">
                        <table class="timetable">
                            ${headerHtml}
                            <tbody>${bodyHtml}</tbody>
                        </table>
                    </div>
                </div>
            `;
        }


        function updateNavControls() {
            nextBtn.disabled = currentPage === 0;
            const maxPage = sortedWeeks.length - 1;
            prevBtn.disabled = currentPage >= maxPage;

            const currentWeekKey = sortedWeeks[currentPage];
            let displayStr = 'Gösterilecek Hafta Bulunamadı';
            if (currentWeekKey) {
                const [year, weekNo] = currentWeekKey.split('-').map(Number);
                const range = getWeekDateRange(year, weekNo);
                displayStr = `Gösterilen Hafta: ${range.start.toLocaleDateString('tr-TR', {day: 'numeric', month: 'long'})} - ${range.end.toLocaleDateString('tr-TR', {day: 'numeric', month: 'long', year: 'numeric'})}`;
            }
            weekRangeDisplay.textContent = displayStr;
        }

        function populateFormForEdit(shoot) {
            form.date.value = shoot.date || '';
            form.day.value = shoot.day || '';
            form.studio.value = shoot.studio || '';
            form.teacher.value = shoot.teacher || '';
            form.time.value = shoot.time || '';
            form.director.value = shoot.director || '';
            form.content.value = shoot.content || '';

            currentEditId = shoot.id;
            submitBtn.textContent = 'Kaydı Güncelle';
            cancelBtn.classList.remove('hidden');
            if (formWrapper.classList.contains('collapsed')) {
                formWrapper.classList.remove('collapsed');
                toggleIcon.classList.remove('rotate-180');
            }
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function resetFormState() {
            form.reset();
            currentEditId = null;
            submitBtn.textContent = 'Çekim Ekle';
            cancelBtn.classList.add('hidden');
        }
        
        formHeaderClickable.addEventListener('click', (e) => {
            if (e.target.closest('button#logout-btn') || e.target.closest('div[class*="absolute"]')) {
                return;
            }
            formWrapper.classList.toggle('collapsed');
            toggleIcon.classList.toggle('rotate-180');
        });

        filterDay.addEventListener('change', processAndRenderData);
        filterStudio.addEventListener('change', processAndRenderData);
        filterTeacher.addEventListener('change', processAndRenderData);
        
        prevBtn.addEventListener('click', () => {
            const maxPage = sortedWeeks.length - 1;
            if (currentPage < maxPage) {
                currentPage++;
                renderCurrentPage();
            }
        });

        nextBtn.addEventListener('click', () => {
            if (currentPage > 0) {
                currentPage--;
                renderCurrentPage();
            }
        });

        weeklyContainer.addEventListener('click', async (e) => {
            const target = e.target.closest('button');
            if (!target) return;

            if (target.classList.contains('delete-btn')) {
                const id = target.getAttribute('data-id');
                const { error } = await db.from('shoots').delete().eq('id', id);
                if(error) console.error("Veri silme hatası:", error);
            }
            if (target.classList.contains('edit-btn')) {
                const id = target.getAttribute('data-id');
                const shootToEdit = allShoots.find(shoot => shoot.id == id);
                if (shootToEdit) {
                    populateFormForEdit(shootToEdit);
                }
            }
        });
        
        cancelBtn.addEventListener('click', resetFormState);

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(form);
            const shootData = {
                studio: formData.get('studio'),
                teacher: formData.get('teacher'),
                date: formData.get('date'),
                day: formData.get('day'),
                time: formData.get('time'),
                director: formData.get('director'),
                content: formData.get('content'),
            };

            let error;
            if (currentEditId) {
                ({ error } = await db.from('shoots').update(shootData).eq('id', currentEditId));
            } else {
                ({ error } = await db.from('shoots').insert([shootData]));
            }

            if (error) {
                console.error("Veri kaydetme/güncelleme hatası: ", error);
            } else {
                resetFormState();
                fetchInitialData();
            }
        });
        
        downloadPdfBtn.addEventListener('click', () => {
            const timetableElement = document.querySelector('#weekly-view-container .bg-white');
            if (!timetableElement) {
                alert("İndirilecek bir tablo bulunamadı.");
                return;
            }

            const originalBtnText = downloadPdfBtn.innerHTML;
            downloadPdfBtn.disabled = true;
            downloadPdfBtn.innerHTML = 'İndiriliyor...';

            html2canvas(timetableElement, { scale: 2 }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const { jsPDF } = window.jspdf;
                
                const pdfWidth = canvas.width;
                const pdfHeight = canvas.height;
                const orientation = pdfWidth > pdfHeight ? 'l' : 'p';

                const pdf = new jsPDF({
                    orientation: orientation,
                    unit: 'px',
                    format: [pdfWidth, pdfHeight]
                });

                pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);

                const weekText = weekRangeDisplay.textContent.replace('Gösterilen Hafta: ', '');
                pdf.save(`cekim_plani_${weekText}.pdf`);
            }).catch(err => {
                console.error("PDF oluşturma hatası:", err);
                alert("PDF oluşturulurken bir hata oluştu. Lütfen konsolu kontrol edin.");
            }).finally(() => {
                downloadPdfBtn.disabled = false;
                downloadPdfBtn.innerHTML = originalBtnText;
            });
        });

        logoutBtn.addEventListener('click', async () => {
            await db.auth.signOut();
            window.location.href = 'login.html';
        });

        document.addEventListener('DOMContentLoaded', () => {
            fetchInitialData();
        });

        async function fetchInitialData() {
            const { data, error } = await db.from('shoots').select('*');
            if (error) {
                console.error("Veri alınamadı:", error);
                loadingDiv.innerText = "Veriler alınırken bir hata oluştu.";
            } else {
                allShoots = data;
                processAndRenderData();
            }
        }
        
        const shootsSubscription = db.channel('public:shoots')
            .on(
                'postgres_changes',
                { event: '*', schema: 'public', table: 'shoots' },
                (payload) => {
                    console.log('Değişiklik algılandı!', payload);
                    fetchInitialData();
                }
            )
            .subscribe();
    </script>
</body>
</html>
